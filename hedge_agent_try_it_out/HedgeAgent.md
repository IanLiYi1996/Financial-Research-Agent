# HedgeAgents: A Balanced-aware Multi-agent Financial Trading System
> HedgeAgents是一个多智能体对冲系统，包含基金经理和股票、外汇、比特币等领域的专家。专家负责各自领域，基金经理协调讨论、审查和整合见解。利用大型语言模型（LLM），HedgeAgents积累了类似人类的投资经验，展现出在极端条件下的稳定性。该系统在3年内实现了400%的总回报，年化回报率达到70%。


## Background
自动化交易已成为现代金融市场的重要投资策略，利用先进算法实时跟踪市场趋势，提高决策速度和投资收益，同时降低风险。人工智能，特别是大型语言模型（LLMs），在金融交易中提供了显著机会，能够分析大量金融和新闻信息，预测市场变化，并生成财务分析报告。尽管这些模型表现出色，但在应对现实市场波动时仍缺乏稳健性，尤其在“快速下跌”场景中，许多基线模型表现不佳，且缺乏风险管理机制。

本研究首次将“对冲”整合进多智能体环境，建立了一个由三位专家和一位经理组成的对冲投资组合。实验结果表明该框架在所有指标上表现优异。

## 相关工作

#### 量化金融

量化金融结合数学和统计方法，解决复杂金融问题。关键应用包括金融衍生品估值、投资组合优化和市场动态分析。机器学习提升了预测建模能力，增强市场预测准确性和算法交易效率。随着金融市场的发展，定量技术的整合对应对市场不确定性至关重要。

#### 大模型代理

LLM（大型语言模型）在推动通用人工智能（AGI）方面具有重要作用。LLM增强了代理的自主性、反应能力和社交互动能力。代理能够执行复杂任务，如自然语言交互、知识整合、信息记忆、逻辑推理和战略规划。基于LLM的代理系统在金融等领域展现出潜力，提供新颖的解决方案应对复杂挑战。

## HedgeAgents

#### 预备知识

目标是优化收益并降低风险，使用对冲策略。利用金融数据（价格和新闻）作为输入。生成并实施交易行动，包括买卖。涉及领域：比特币、股票和外汇。

#### 整体框架

HedgeAgents框架模拟对冲基金架构，优化多资产投资组合的风险对冲。包含：

* 四个角色：比特币分析师Dave、道琼斯分析师Bob、外汇分析师Emily和对冲基金经理Otto。

* 三种多代理协调会议：预算分配会议（BAC）、经验分享会议（ESC）、极端市场会议（EMC），用于预算分配、经验总结和紧急行动。

#### 单个代理的定义

单一投资代理模拟人类决策过程，包含23种金融分析工具（如指标分析、加密货币市场分析、风险管理）。行动类型有8种（如买入/卖出/持有），记忆分为三类：基本市场信息记忆、投资反思、一般经验。工作流程包括：记忆检索、决策制定和反思更新。

记忆检索通过总结查询从记忆中检索5个相似案例以增强决策。

决策制定基于经验，通过强化学习优化总回报，使用LLM生成兼容的行动。

反思更新将市场信息和查询存入基本记忆，决策过程中的反思和行动更新到投资反思记忆。

#### 对冲代理的协作

- 预算分配会议：每30天召开，Dave（比特币）、Bob（股票）、Emily（外汇）向经理Otto报告当前利润和预算期望，Otto整合报告评估未来收益，并通过引入预期总回报、整体投资组合风险和条件预期回撤风险来优化资产配置。

- 经验分享会议：投资周期结束时，三位对冲代理进行知识积累，每位代理分享典型案例，讨论后将见解存档以增强未来决策。

- 极端市场会议：在市场波动超过5%或三天累计超过10%时召开，危机代理需展示当前投资组合、危机原因及应对计划，其他代理提供建议以优化应对策略。


## 实验

#### 数据集

数据集涵盖比特币、外汇和道琼斯成分股，来源于Yahoo Finance和Alpaca News API。时间范围为2015年1月1日至2023年12月31日，包含每日开盘、最高、最低、收盘价、成交量和调整后收盘价。每个资产还包括每日新闻更新和60个标准技术分析指标。

#### 评估指标

比较HedgeAgents与基线的9个金融指标，包括：

* 2个利润指标：总回报（TR）、年回报率（ARR）。

* 3个风险调整利润指标：夏普比率（SR）、卡尔玛比率（CR）、索提诺比率（SOR）。

* 2个风险指标：最大回撤（MDD）、波动率（VOL）。

* 2个多样性指标：熵（ENT）、有效投注数（ENB）。

#### 实现细节

数据集分为训练集（2015年1月1日至2020年12月31日）和测试集（2021年1月1日至2023年12月31日），测试阶段仅使用历史价格以避免数据泄漏。所有基线模型在相同的强化学习环境中训练和测试。使用Optuna进行基线配置的超参数优化。

LLM方法和HedgeAgents均使用GPT-4-1106-preview版本，温度设置为0.7。内存模块采用基于文本相似度的存储和检索机制，使用text-embedding-3-large模型，top-k值为5。LLM方法根据各自研究的建议调整至最佳配置。

## 整体表现

选取了多种经典和先进的基线模型进行比较，包括三种规则基础的投资策略（MV、ZMR、TSM）、三种基于强化学习的金融代理（SAC、DeepTrader、AlphaMix+）和三种基于大语言模型的方法（FinGPT、FinMem、FinAgent）。强化学习方法在理解金融市场复杂性和不确定性方面优于规则基础策略，DeepTrader和AlphaMix+的年化收益率（ARR）分别为32.78%和37.59%，显著高于规则模型（MV: 13.03%，ZMR: -7.25%，TSM: 19.13%）。

基于大语言模型的方法（如FinGPT、FinMem、FinAgent）在风险调整指标（如夏普比率和信息比率）上超越了强化学习方法，FinMem的ARR为47.67%，总收益率（TR）为221.99%，显示出其在信息处理和决策上的优势。

HedgeAgents在各项指标上表现卓越，主要得益于以下因素：

* 战略预算分配：动态预算分配优化了多资产类别的投资，模型实现了71.60%的年化收益率（ARR）和405.34%的总回报（TR），显示出战略预算分配的有效性。

* 风险管理：HedgeAgents的最大回撤（MDD）为14.21%，在风险管理方面优于所有基准模型。

* 多样化与稳健性：HedgeAgents拥有最高的投资组合多样性（ENT和ENB），展现出对个别资产风险的韧性。

在2022年5月，尽管大多数基准模型的投资组合遭遇重大损失，HedgeAgents成功应对挑战，进一步证明其卓越能力。

总体而言，HedgeAgents在收益、风险管理和多样化方面实现了良好平衡，适应复杂动态的投资环境。

## 消融分析

#### 会议模块有效性：

* ESC模块对投资组合多样化和尾部风险对冲至关重要，去除后ENT指标下降16.63%。

* BAC模块对收益影响最大，去除后年化收益下降37.75%。

* EMC模块对风险规避和收益稳健性重要，去除后最大回撤率增加71.93%。

* 三个模块的协同效应显著，整体表现优于单独模块。


#### LLM有效性：

* 六种代表性模型在HedgeAgents框架中测试，结果显示框架不依赖于特定语言模型。

* 参数规模增加有助于提升投资收益，gpt-4-1106-preview表现最佳。

* 封闭源模型在各项指标上表现优异，开源模型Qwen-72B表现接近封闭源模型。

* 选择GPT-4作为框架核心，系统三年总成本仅为15美元。

没有套期保值的单一资产表现

在比特币市场，HedgeAgents实现约210%的累计回报，远超其他模型，得益于专家Dave对区块链数据和市场趋势的分析。

在AAPL股票市场，HedgeAgents累计回报约160%，优于FinAgent和FinMem，专家Bob通过财务分析和市场预测保持稳定增长。

在YUAN外汇市场，HedgeAgents实现约9%的正回报，专家Emily利用宏观经济指标和地缘政治事件进行小幅盈利。

结果显示HedgeAgents在不同资产类别和市场条件下的多样性和稳健性。

#### 可视化

通过可视化分析单个代理的决策过程，展示了Otto的对冲策略。

单一代理可视化。以比特币分析师Dave为例，他的工作流程始于市场分析，注意到比特币价格显著上涨。Dave查询历史表现，回忆在乐观条件下的投资经验，强调快速平仓的挑战。在决策阶段，Dave考虑当前宏观经济政策的积极影响，决定购买50%的比特币，并持续监控市场。反思阶段显示，资产在四个交易日内增值7.43%，验证了其策略的有效性。Dave的工作流程体现了历史经验与实时分析的结合，提升了在波动市场中的决策质量。


对冲专家可视化。Otto是一个对冲专家，在比特币市场下跌10.22%时进行决策。目前投资组合为13.2%现金和56.8%比特币。风险评估考虑了比特币价格波动、联邦储备政策和市场流动性。Otto决定采取谨慎的平衡策略，避免过度交易和冒险策略。提出的对冲策略包括投资组合多样化、期权交易和风险管理。该策略在市场动荡中有效，最终资产在两天内增长8.6%。


## 总结

HedgeAgents是一个多智能体系统，旨在通过对冲策略增强金融行动的稳健性。开发了一套专门的对冲代理，并定期组织会议以促进代理间的合作。实验结果显示该框架表现优越且稳健。可视化观察表明，HedgeAgents在记忆中生成的投资经验与人类专家相当。